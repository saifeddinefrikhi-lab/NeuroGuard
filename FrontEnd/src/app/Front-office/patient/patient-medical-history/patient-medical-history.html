<div class="container-fluid px-4 mt-3 mb-5">
  <h2 class="mb-4">My Medical History</h2>

  <div *ngIf="loading" class="text-center my-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="ti ti-alert-circle me-2"></i>{{ errorMessage }}
  </div>
  
  <div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="ti ti-check-circle me-2"></i>{{ successMessage }}
  </div>

  <!-- Medical Information Card -->
  <div *ngIf="history && !loading" class="modern-card mb-4">
    <div class="card-header-modern simple">
      <h3 class="section-title mb-0">
        <i class="ti ti-stethoscope"></i> Medical Information
      </h3>
    </div>
    <div class="card-body-modern">
      <!-- Basic Info Grid -->
      <div class="info-grid mb-4">
        <div class="info-card">
          <div class="info-icon diagnosis-icon">
            <i class="ti ti-stethoscope"></i>
          </div>
          <div class="info-content">
            <span class="info-label">Diagnosis</span>
            <p class="info-value">{{ history.diagnosis || 'Not specified' }}</p>
          </div>
        </div>
        <div class="info-card">
          <div class="info-icon date-icon">
            <i class="ti ti-calendar"></i>
          </div>
          <div class="info-content">
            <span class="info-label">Diagnosis Date</span>
            <p class="info-value">{{ history.diagnosisDate ? (history.diagnosisDate | date:'MMM d, y') : 'Not specified' }}</p>
          </div>
        </div>
        <div class="info-card">
          <div class="info-icon genetic-icon">
            <i class="ti ti-dna"></i>
          </div>
          <div class="info-content">
            <span class="info-label">Genetic Risk</span>
            <p class="info-value">{{ history.geneticRisk || 'Not assessed' }}</p>
          </div>
        </div>
      </div>

      <!-- Medical Context Section -->
      <div class="section mb-5">
        <h5 class="section-title"><i class="ti ti-alert-hexagon"></i> Medical Context</h5>
        <div class="context-grid">
          <div class="context-item" *ngIf="history.familyHistory">
            <span class="context-label">Family History</span>
            <div class="context-value">{{ history.familyHistory }}</div>
          </div>
          <div class="context-item" *ngIf="history.environmentalFactors">
            <span class="context-label">Environmental Factors</span>
            <div class="context-value">{{ history.environmentalFactors }}</div>
          </div>
          <div class="context-item" *ngIf="history.comorbidities">
            <span class="context-label">Comorbidities</span>
            <div class="context-value">{{ history.comorbidities }}</div>
          </div>
        </div>
      </div>

      <!-- Allergies Section -->
      <div class="section mb-5">
        <h5 class="section-title"><i class="ti ti-alert-circle"></i> Allergies</h5>
        <div class="allergies-container">
          <div class="allergy-item medication-allergy" *ngIf="history.medicationAllergies">
            <i class="ti ti-pill"></i>
            <div>
              <span class="allergy-type">Medications</span>
              <p class="allergy-value">{{ history.medicationAllergies }}</p>
            </div>
          </div>
          <div class="allergy-item environmental-allergy" *ngIf="history.environmentalAllergies">
            <i class="ti ti-wind"></i>
            <div>
              <span class="allergy-type">Environmental</span>
              <p class="allergy-value">{{ history.environmentalAllergies }}</p>
            </div>
          </div>
          <div class="allergy-item food-allergy" *ngIf="history.foodAllergies">
            <i class="ti ti-apple"></i>
            <div>
              <span class="allergy-type">Food</span>
              <p class="allergy-value">{{ history.foodAllergies }}</p>
            </div>
          </div>
          <div class="allergy-placeholder" *ngIf="!history.medicationAllergies && !history.environmentalAllergies && !history.foodAllergies">
            <i class="ti ti-check"></i> No known allergies
          </div>
        </div>
      </div>

      <!-- Surgeries Section -->
      <div class="section mb-5">
        <h5 class="section-title"><i class="ti ti-surgical-mask"></i> Surgical History</h5>
        <div class="surgeries-list" *ngIf="history.surgeries && history.surgeries.length > 0; else noSurgeries">
          <div class="surgery-item" *ngFor="let surgery of history.surgeries">
            <div class="surgery-marker"></div>
            <div class="surgery-content">
              <p class="surgery-description">{{ surgery.description }}</p>
              <span class="surgery-date">
                <i class="ti ti-calendar-event"></i> {{ surgery.date | date:'MMM d, yyyy' }}
              </span>
            </div>
          </div>
        </div>
        <ng-template #noSurgeries>
          <div class="empty-state">
            <i class="ti ti-check-circle"></i>
            <p>No surgical procedures recorded</p>
          </div>
        </ng-template>
      </div>

      <!-- Care Team -->
      <div class="section mb-5">
        <h5 class="section-title"><i class="ti ti-users"></i> Care Team</h5>
        <div class="team-grid">
          <div class="team-section">
            <h6 class="team-label"><i class="ti ti-user-check"></i> Healthcare Providers</h6>
            <div class="team-members" *ngIf="history.providerNames && history.providerNames.length > 0; else noProviders">
              <span class="team-badge" *ngFor="let name of history.providerNames">{{ name }}</span>
            </div>
            <ng-template #noProviders>
              <p class="text-muted">No providers assigned</p>
            </ng-template>
          </div>
          <div class="team-section">
            <h6 class="team-label"><i class="ti ti-user-heart"></i> Caregivers</h6>
            <div class="team-members" *ngIf="history.caregiverNames && history.caregiverNames.length > 0; else noCaregivers">
              <span class="team-badge caregiver" *ngFor="let name of history.caregiverNames">{{ name }}</span>
            </div>
            <ng-template #noCaregivers>
              <p class="text-muted">No caregivers assigned</p>
            </ng-template>
          </div>
        </div>
      </div>

      <!-- Record Metadata -->
      <div class="record-metadata">
        <div class="metadata-item">
          <span class="metadata-label">Record Created</span>
          <span class="metadata-value">{{ history.createdAt | date:'MMM d, yyyy' }}</span>
        </div>
        <div class="metadata-item">
          <span class="metadata-label">Last Updated</span>
          <span class="metadata-value">{{ history.updatedAt | date:'MMM d, yyyy' }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Files Section -->
  <div class="modern-card">
    <div class="card-header-modern simple">
      <div class="d-flex justify-content-between align-items-center">
        <h3 class="section-title mb-0">
          <i class="ti ti-file-text"></i> My Documents
        </h3>
        <label for="fileUpload" class="btn btn-primary btn-sm" [class.disabled]="uploading">
          <i class="ti ti-upload"></i>
          <span *ngIf="uploading" class="spinner-border spinner-border-sm ms-1"></span>
          <span *ngIf="!uploading">Upload File</span>
        </label>
        <input type="file" id="fileUpload" class="d-none" (change)="onFileSelected($event)" [disabled]="uploading">
      </div>
    </div>
    <div class="card-body-modern">
      <div *ngIf="files.length === 0" class="empty-state">
        <i class="ti ti-file-off"></i>
        <p>No documents uploaded yet</p>
      </div>
      <div class="files-list" *ngIf="files.length > 0">
        <div class="file-item" *ngFor="let file of files">
          <div class="file-icon">
            <i class="ti ti-file"></i>
          </div>
          <div class="file-info">
            <p class="file-name">{{ file.fileName }}</p>
            <div class="file-meta">
              <span class="file-type">{{ file.fileType }}</span>
              <span class="file-date">{{ file.uploadedAt | date:'MMM d, yyyy' }}</span>
            </div>
          </div>
          <div class="file-actions">
            <button class="btn-modern btn-download" (click)="downloadFile(file.id, file.fileName)" title="Download file">
              <i class="ti ti-download"></i>
              <span>Download</span>
            </button>
            <button class="btn-modern btn-delete" (click)="deleteFile(file.id)" title="Delete file">
              <i class="ti ti-trash"></i>
              <span>Delete</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>