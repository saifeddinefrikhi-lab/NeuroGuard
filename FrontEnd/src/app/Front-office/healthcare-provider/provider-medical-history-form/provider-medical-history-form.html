<div class="container-fluid px-4 mt-0 mb-5">
  <div class="page-header mb-4">
    <div class="page-header-content">
      <h1 class="page-title">
        <i class="ti ti-clipboard-heart"></i>
        {{ isEditMode ? 'Edit' : 'Add' }} Medical History
      </h1>
      <p class="page-subtitle">Capture a complete medical profile with structured details and care team context</p>
    </div>
  </div>

  <div *ngIf="loading" class="text-center my-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
    <strong><i class="ti ti-alert-circle"></i> Error:</strong>
    <div class="mt-2">{{ errorMessage }}</div>
    <button type="button" class="btn-close" (click)="errorMessage = ''" aria-label="Close"></button>
  </div>

  <!-- Validation Summary -->
  <div *ngIf="submitted && form.invalid" class="alert alert-warning alert-dismissible fade show" role="alert">
    <strong><i class="ti ti-alert-circle"></i> Please fix the following errors:</strong>
    <ul class="mb-0 mt-2">
      <li *ngIf="form.get('patientId')?.invalid && form.get('patientId')?.errors?.['required']">Patient is required</li>
      <li *ngIf="hasInsufficientMedicalData()">{{ getInsufficientDataMessage() }}</li>
      <li *ngIf="hasFieldError('diagnosis')">{{ getFieldError('diagnosis') }}</li>
      <li *ngIf="hasFieldError('diagnosisDate')">{{ getFieldError('diagnosisDate') }}</li>
      <li *ngIf="hasFieldError('progressionStage')">{{ getFieldError('progressionStage') }}</li>
      <li *ngIf="hasFieldError('geneticRisk')">{{ getFieldError('geneticRisk') }}</li>
    </ul>
    <button type="button" class="btn-close" (click)="submitted = false" aria-label="Close"></button>
  </div>

  <form [formGroup]="form" (ngSubmit)="onSubmit()" *ngIf="!loading">
    <div class="modern-card mb-4">
      <div class="card-header">
        <div class="card-title">
          <i class="ti ti-user"></i>
          Patient Selection
        </div>
        <span class="card-subtitle">Select the patient this record belongs to</span>
      </div>
      <div class="card-body">
        <!-- Patient Selection (only in add mode) -->
        <div class="mb-3" *ngIf="!isEditMode">
          <label class="form-label">
            Patient <span class="text-danger">*</span>
            <small class="text-danger" *ngIf="hasFieldError('patientId')"> - {{ getFieldError('patientId') }}</small>
          </label>
          <div *ngIf="patientsLoading" class="spinner-border spinner-border-sm" role="status">
            <span class="visually-hidden">Loading patients...</span>
          </div>
          <select 
            class="form-control" 
            formControlName="patientId"
            (change)="onPatientSelect($event)"
            [class.is-invalid]="hasFieldError('patientId')"
            [disabled]="patientsLoading || patients.length === 0">
            <option value="">Select a patient</option>
            <option *ngFor="let p of patients" [value]="p.id">
              {{ p.firstName }} {{ p.lastName }} ({{ p.username }})
            </option>
          </select>
          <div *ngIf="patients.length === 0 && !patientsLoading" class="text-warning mt-2">
            No patients available. Please ensure patients are assigned to you.
          </div>
        </div>
      </div>
    </div>

    <!-- hidden patientId field -->
    <input type="hidden" formControlName="patientId" />

    <div class="modern-card mb-4">
      <div class="card-header">
        <div class="card-title">
          <i class="ti ti-stethoscope"></i>
          Core Diagnosis
        </div>
        <span class="card-subtitle">Primary clinical details and stage assessment</span>
      </div>
      <div class="card-body">
        <div class="form-grid">
          <div class="form-field">
            <label for="diagnosis" class="form-label">
              Diagnosis <span class="text-danger">*</span>
              <small class="text-danger" *ngIf="hasFieldError('diagnosis')"> - {{ getFieldError('diagnosis') }}</small>
            </label>
            <input 
              type="text" 
              class="form-control" 
              id="diagnosis" 
              formControlName="diagnosis"
              [class.is-invalid]="hasFieldError('diagnosis')"
              placeholder="Enter diagnosis (required)">
          </div>

          <div class="form-field">
            <label for="diagnosisDate" class="form-label">
              Diagnosis Date <span class="text-danger">*</span>
              <small class="text-danger" *ngIf="hasFieldError('diagnosisDate')"> - {{ getFieldError('diagnosisDate') }}</small>
            </label>
            <input 
              type="date" 
              class="form-control" 
              id="diagnosisDate" 
              formControlName="diagnosisDate"
              [class.is-invalid]="hasFieldError('diagnosisDate')">
          </div>

          <div class="form-field">
            <label for="progressionStage" class="form-label">
              Progression Stage <span class="text-danger">*</span>
              <small class="text-danger" *ngIf="hasFieldError('progressionStage')"> - {{ getFieldError('progressionStage') }}</small>
            </label>
            <select 
              class="form-control" 
              id="progressionStage" 
              formControlName="progressionStage"
              [class.is-invalid]="hasFieldError('progressionStage')">
              <option value="">Select stage (required)</option>
              <option value="MILD">Mild</option>
              <option value="MODERATE">Moderate</option>
              <option value="SEVERE">Severe</option>
            </select>
          </div>

          <div class="form-field">
            <label for="geneticRisk" class="form-label">
              Genetic Risk
              <small class="text-danger" *ngIf="hasFieldError('geneticRisk')"> - {{ getFieldError('geneticRisk') }}</small>
            </label>
            <input 
              type="text" 
              class="form-control" 
              id="geneticRisk" 
              formControlName="geneticRisk"
              [class.is-invalid]="hasFieldError('geneticRisk')"
              placeholder="Genetic risk factors">
          </div>
        </div>
      </div>
    </div>

    <div class="modern-card mb-4">
      <div class="card-header">
        <div class="card-title">
          <i class="ti ti-notes"></i>
          Medical Context
        </div>
        <span class="card-subtitle">Background factors and comorbid conditions</span>
      </div>
      <div class="card-body">
        <div class="form-grid">
          <div class="form-field">
            <label for="familyHistory" class="form-label">Family History</label>
            <textarea 
              class="form-control" 
              id="familyHistory" 
              formControlName="familyHistory"
              rows="2"
              placeholder="Family history details"></textarea>
          </div>

          <div class="form-field">
            <label for="environmentalFactors" class="form-label">Environmental Factors</label>
            <textarea 
              class="form-control" 
              id="environmentalFactors" 
              formControlName="environmentalFactors"
              rows="2"
              placeholder="Environmental factors"></textarea>
          </div>

          <div class="form-field">
            <label for="comorbidities" class="form-label">Comorbidities</label>
            <textarea 
              class="form-control" 
              id="comorbidities" 
              formControlName="comorbidities"
              rows="2"
              placeholder="Other conditions"></textarea>
          </div>
        </div>
      </div>
    </div>

    <div class="modern-card mb-4">
      <div class="card-header">
        <div class="card-title">
          <i class="ti ti-allergy"></i>
          Allergies
        </div>
        <span class="card-subtitle">Document allergy triggers and reactions</span>
      </div>
      <div class="card-body">
        <div class="form-grid">
          <div class="form-field">
            <label for="medicationAllergies" class="form-label">Medication Allergies</label>
            <textarea 
              class="form-control" 
              id="medicationAllergies" 
              formControlName="medicationAllergies"
              rows="2"
              placeholder="Medication allergies"></textarea>
          </div>

          <div class="form-field">
            <label for="environmentalAllergies" class="form-label">Environmental Allergies</label>
            <textarea 
              class="form-control" 
              id="environmentalAllergies" 
              formControlName="environmentalAllergies"
              rows="2"
              placeholder="Environmental allergies"></textarea>
          </div>

          <div class="form-field">
            <label for="foodAllergies" class="form-label">Food Allergies</label>
            <textarea 
              class="form-control" 
              id="foodAllergies" 
              formControlName="foodAllergies"
              rows="2"
              placeholder="Food allergies"></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Surgeries (dynamic list) -->
    <div class="modern-card mb-4">
      <div class="card-header">
        <div class="card-title">
          <i class="ti ti-scalpel"></i>
          Surgical History
        </div>
        <span class="card-subtitle">Track procedures and dates</span>
      </div>
      <div class="card-body">
        <div formArrayName="surgeries" class="surgery-list">
          <ng-container *ngFor="let surgery of surgeries.controls; let i = index" [formGroupName]="i">
            <div class="surgery-row" [class.invalid-row]="isSurgeryInvalid(i)">
              <div class="surgery-field">
                <label class="field-label">Description</label>
                <input 
                  type="text" 
                  class="form-control" 
                  formControlName="description"
                  [class.is-invalid]="submitted && surgery.get('description')?.invalid"
                  placeholder="Surgery description">
                <div class="invalid-feedback d-block" *ngIf="submitted && surgery.get('description')?.invalid">
                  Surgery description is required
                </div>
              </div>
              <div class="surgery-field">
                <label class="field-label">Date</label>
                <input 
                  type="date" 
                  class="form-control" 
                  formControlName="date"
                  [class.is-invalid]="submitted && surgery.get('date')?.invalid">
                <div class="invalid-feedback d-block" *ngIf="submitted && surgery.get('date')?.invalid">
                  Surgery date is required
                </div>
              </div>
              <div class="surgery-actions">
                <button type="button" class="btn btn-danger" (click)="removeSurgery(i)">
                  <i class="ti ti-trash"></i>
                </button>
              </div>
            </div>
          </ng-container>
        </div>
        <button type="button" class="btn btn-secondary" (click)="addSurgery()">
          <i class="ti ti-plus"></i> Add Surgery
        </button>
      </div>
    </div>

    <!-- Additional Providers as checkboxes (selection by name) -->
    <div class="modern-card mb-4">
      <div class="card-header">
        <div class="card-title">
          <i class="ti ti-users"></i>
          Care Team
        </div>
        <span class="card-subtitle">Assign additional providers and caregivers</span>
      </div>
      <div class="card-body">
        <div class="team-section">
          <label class="form-label">Additional Providers</label>
          <div *ngIf="providers.length === 0" class="alert alert-info mb-0">
            No other providers available.
          </div>
          <div class="team-grid">
            <div *ngFor="let p of providers" class="team-item">
              <div class="form-check">
                <input 
                  class="form-check-input" 
                  type="checkbox" 
                  [checked]="isProviderSelected(p)"
                  (change)="toggleProvider(p, $event)"
                  [id]="'provider-' + p.id">
                <label class="form-check-label" [for]="'provider-' + p.id">
                  {{ p.firstName }} {{ p.lastName }} ({{ p.email }})
                </label>
              </div>
            </div>
          </div>
        </div>

        <div class="team-section mt-4">
          <label class="form-label">Caregivers</label>
          <div *ngIf="caregiversLoading" class="spinner-border spinner-border-sm" role="status">
            <span class="visually-hidden">Loading caregivers...</span>
          </div>
          <div *ngIf="caregivers.length === 0 && !caregiversLoading" class="alert alert-info mb-0">
            No caregivers available.
          </div>
          <div class="team-grid">
            <div *ngFor="let c of caregivers" class="team-item">
              <div class="form-check">
                <input 
                  class="form-check-input" 
                  type="checkbox" 
                  [checked]="isCaregiverSelected(c)"
                  (change)="toggleCaregiver(c, $event)"
                  [id]="'caregiver-' + c.id">
                <label class="form-check-label" [for]="'caregiver-' + c.id">
                  {{ c.firstName }} {{ c.lastName }} ({{ c.email }})
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>


    <!-- Submit and Cancel Buttons -->
    <div class="form-actions">
      <button type="submit" class="btn-modern btn-primary" [disabled]="submitting">
        <span *ngIf="submitting" class="spinner-border spinner-border-sm me-2"></span>
        {{ isEditMode ? 'Update' : 'Create' }}
      </button>
      <button type="button" class="btn-modern btn-outline" (click)="onCancel()">Cancel</button>
    </div>
  </form>
</div>